apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: app
  name: web-rtc-server
spec:
  selector:
    matchLabels:
      k8s-app: web-rtc-server
  replicas: 1
  template:
    metadata:
      name: web-rtc-server
      namespace: app
      labels:
        k8s-app: web-rtc-server
    spec:
      containers:
        - name: coturn
          image: registry.mouse.center:1443/coturn/coturn
          ports:
            - containerPort: 8080
              name: web
            - containerPort: 3478
              name: turn
              protocol: TCP
            - containerPort: 3478
              name: turn-udp
              protocol: UDP
            - containerPort: 5349
              name: tls-turn
              protocol: TCP
            - containerPort: 5349
              name: tls-turn-udp
              protocol: UDP
            - containerPort: 49152
              protocol: UDP
            - containerPort: 49153
              protocol: UDP
            - containerPort: 49154
              protocol: UDP
            - containerPort: 49155
              protocol: UDP
            - containerPort: 49156
              protocol: UDP
            - containerPort: 49157
              protocol: UDP
            - containerPort: 49158
              protocol: UDP
            - containerPort: 49159
              protocol: UDP
            - containerPort: 49160
              protocol: UDP
            - containerPort: 49161
              protocol: UDP
            - containerPort: 49162
              protocol: UDP
          volumeMounts:
            - mountPath: /etc/coturn/turnserver.conf
              name: coturn
              subPath: coturn/config/turnserver.conf
            - mountPath: /var/lib/coturn/
              name: coturn
              subPath: coturn/data
      volumes:
        - name: coturn
          nfs:
            path: /volume2/k8s/web-rtc
            server: nas
---
kind: Service
apiVersion: v1
metadata:
  name: web-rtc-server
  namespace: app
spec:
  type: NodePort
  ports:
    - port: 80
      name: web
      targetPort: 8080
    - port: 3478
      name: turn
      targetPort: 3478
      protocol: TCP
    - port: 3478
      name: turn-udp
      targetPort: 3478
      protocol: UDP
    - port: 5349
      name: tls-turn
      protocol: TCP
    - port: 5349
      name: tls-turn-udp
      protocol: UDP
    - port: 49152
      name: udp-49152
      targetPort: 49152
      nodePort: 30152
      protocol: UDP
    - port: 49153
      name: udp-49153
      targetPort: 49153
      nodePort: 30153
      protocol: UDP
    - port: 49154
      name: udp-49154
      targetPort: 49154
      nodePort: 30154
      protocol: UDP
    - port: 49155
      name: udp-49155
      targetPort: 49155
      nodePort: 30155
      protocol: UDP
    - port: 49156
      name: udp-49156
      targetPort: 49156
      nodePort: 30156
      protocol: UDP
    - port: 49157
      name: udp-49157
      targetPort: 49157
      nodePort: 30157
      protocol: UDP
    - port: 49158
      name: udp-49158
      targetPort: 49158
      nodePort: 30158
      protocol: UDP
    - port: 49159
      name: udp-49159
      targetPort: 49159
      nodePort: 30159
      protocol: UDP
    - port: 49160
      name: udp-49160
      targetPort: 49160
      nodePort: 30160
      protocol: UDP
    - port: 49161
      name: udp-49161
      targetPort: 49161
      nodePort: 30161
      protocol: UDP
    - port: 49162
      name: udp-49162
      targetPort: 49162
      nodePort: 30162
      protocol: UDP
---

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  namespace: app
  name: coturn-admin
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: downloader-web-auth
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required'
spec:
  ingressClassName: "nginx"
  rules:
    - host: coturn.mouse.center
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: web-rtc-server
                port:
                  name: web